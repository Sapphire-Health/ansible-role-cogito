# why does it run the script even when test query returns null?
# how can we restructure clarity_report_databases.db.data_path and log_path so that T-SQL will iterate over varying numbers of filepaths clarity_report_databases.db.data_file_count?
# consider index var
#
# These recommended DB settings are correct by default; we don't enforce them with ansible:
#     collation is SQL_Latin1_General_CP1_CI_AS, Default Cursor is set to GLOBAL, Confirm the Page Verify setting is set to CHECKSUM,

---
- name: Add tags to all tasks
  tags:
    - sql
    - caboodle
    - clarity
  block:
    - name: Configure Clarity Report SQL Databases
      when: clarity_report_databases is defined
      block:
        - name: Create Clarity SQL Database Files with T-SQL
          ansible.windows.win_dsc:
            resource_name: SqlScriptQuery
            Id: "ConfigureDatabaseFiles"
            InstanceName: "{{ dsc_instancename }}"
            Variable: "NAME={{ db.name }}, SIZE={{ db.db_size }}, MAXSIZE={{ db.db_max_size }}, FILEGROWTH={{ db.db_growth }}, DATAPATH={{ db.data_path }},LOGSIZE={{ db.log_size }}, LOGMAXSIZE={{ db.log_max_size }}, LOGFILEGROWTH={{ db.log_growth }}, LOGFILEPATH={{ db.log_path }}"
            Encrypt: Optional
            SetQuery: |
              USE [master]
              GO
              CREATE DATABASE $(NAME)
              ON
              PRIMARY
                  (NAME = $(NAME)1,
                  FILENAME = '$(DATAPATH)1\mnt\CLRpt1.mdf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH)),
                  ( NAME = $(NAME)2,
                  FILENAME = '$(DATAPATH)2\mnt\CLRpt2.ndf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH)),
                  ( NAME = $(NAME)3,
                  FILENAME = '$(DATAPATH)3\mnt\CLRpt3.ndf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH)),
                  ( NAME = $(NAME)4,
                  FILENAME = '$(DATAPATH)4\mnt\CLRpt4.ndf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH)),
                  ( NAME = $(NAME)5,
                  FILENAME = '$(DATAPATH)5\mnt\CLRpt5.ndf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH)),
                  ( NAME = $(NAME)6,
                  FILENAME = '$(DATAPATH)6\mnt\CLRpt6.ndf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH)),
                  ( NAME = $(NAME)7,
                  FILENAME = '$(DATAPATH)7\mnt\CLRpt7.ndf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH)),
                  ( NAME = $(NAME)8,
                  FILENAME = '$(DATAPATH)8\mnt\CLRpt8.ndf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH))
              LOG ON
                 (NAME = $(NAME)Log,
                  FILENAME = '$(LOGFILEPATH)\mnt\CLRpt.ldf',
                  SIZE = $(LOGSIZE),
                  MAXSIZE = $(LOGMAXSIZE),
                  FILEGROWTH = $(LOGFILEGROWTH));
              GO
            GetQuery: |
              USE [master]
              GO
              SELECT * FROM sys.master_files
              WHERE type_desc = 'ROWS'
              AND name = '$(NAME)'
              GO
            TestQuery: |
              DECLARE @dbname nvarchar(128)
              SET @dbname = N'$(NAME)'
              SELECT
              CASE
                  WHEN EXISTS (
                      SELECT name
                      FROM sys.databases
                      WHERE name = @dbname
                  ) THEN NULL
                  ELSE 'DB $(NAME) not found; running DB creation'
              END AS Result;
          loop: "{{ clarity_report_databases }}"
          loop_control:
            loop_var: db

    - name: Configure Clarity Stage SQL Databases
      when: clarity_stage_databases is defined
      block:
        - name: Create Cogito SQL Database Files with T-SQL
          ansible.windows.win_dsc:
            resource_name: SqlScriptQuery
            Id: "ConfigureDatabaseFiles"
            InstanceName: "{{ dsc_instancename }}"
            Variable: "NAME={{ db.name }}, SIZE={{ db.db_size }}, MAXSIZE={{ db.db_max_size }}, FILEGROWTH={{ db.db_growth }}, DATAPATH={{db.data_path}},LOGSIZE={{ db.log_size }}, LOGMAXSIZE={{ db.log_max_size }}, LOGFILEGROWTH={{ db.log_growth }}, LOGFILEPATH={{ db.log_path }}"
            Encrypt: Optional
            SetQuery: |
              USE [master]
              GO
              CREATE DATABASE $(NAME)
              ON
              PRIMARY
                  (NAME = $(NAME)1,
                  FILENAME = '$(DATAPATH)1\mnt\CLStg1.mdf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH)),
                  ( NAME = $(NAME)2,
                  FILENAME = '$(DATAPATH)2\mnt\CLStg2.ndf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH))
              LOG ON
                 (NAME = $(NAME)Log,
                  FILENAME = '$(LOGFILEPATH)\mnt\CLStg.ldf',
                  SIZE = $(LOGSIZE),
                  MAXSIZE = $(LOGMAXSIZE),
                  FILEGROWTH = $(LOGFILEGROWTH));
              GO
            GetQuery: |
              USE [master]
              GO
              SELECT * FROM sys.master_files
              WHERE type_desc = 'ROWS'
              AND name = '$(NAME)'
              GO
            TestQuery: |
              SELECT
              CASE
                  WHEN EXISTS (
                      SELECT name
                      FROM sys.databases
                      WHERE name = '$(NAME)'
                  ) THEN NULL
                  ELSE 'DB $(NAME) not found; running DB creation'
              END AS Result;
          loop: "{{ clarity_stage_databases }}"
          loop_control:
            loop_var: db

    - name: Configure Caboodle Report SQL Databases
      when: caboodle_report_databases is defined
      block:
      - name: Create Caboodle SQL Database Files with T-SQL
        ansible.windows.win_dsc:
          resource_name: SqlScriptQuery
          Id: "ConfigureDatabaseFiles"
          InstanceName: "{{ dsc_instancename }}"
          Variable: "NAME={{ db.name }}, SIZE={{ db.db_size }}, MAXSIZE={{ db.db_max_size }}, FILEGROWTH={{ db.db_growth }}, DATAPATH={{ db.data_path }},LOGSIZE={{ db.log_size }}, LOGMAXSIZE={{ db.log_max_size }}, LOGFILEGROWTH={{ db.log_growth }}, LOGFILEPATH={{ db.log_path }}"
          Encrypt: Optional
          SetQuery: |
            USE [master]
            GO
            CREATE DATABASE $(NAME)
            ON
            PRIMARY
                (NAME = $(NAME)1,
                FILENAME = '$(DATAPATH)1\mnt\CDWRpt1.mdf',
                SIZE = $(SIZE),
                MAXSIZE = $(MAXSIZE),
                FILEGROWTH = $(FILEGROWTH)),
                ( NAME = $(NAME)2,
                FILENAME = '$(DATAPATH)2\mnt\CDWRpt2.ndf',
                SIZE = $(SIZE),
                MAXSIZE = $(MAXSIZE),
                FILEGROWTH = $(FILEGROWTH)),
                ( NAME = $(NAME)3,
                FILENAME = '$(DATAPATH)3\mnt\CDWRpt3.ndf',
                SIZE = $(SIZE),
                MAXSIZE = $(MAXSIZE),
                FILEGROWTH = $(FILEGROWTH)),
                ( NAME = $(NAME)4,
                FILENAME = '$(DATAPATH)4\mnt\CDWRpt4.ndf',
                SIZE = $(SIZE),
                MAXSIZE = $(MAXSIZE),
                FILEGROWTH = $(FILEGROWTH)),
                ( NAME = $(NAME)5,
                FILENAME = '$(DATAPATH)5\mnt\CDWRpt5.ndf',
                SIZE = $(SIZE),
                MAXSIZE = $(MAXSIZE),
                FILEGROWTH = $(FILEGROWTH)),
                ( NAME = $(NAME)6,
                FILENAME = '$(DATAPATH)6\mnt\CDWRpt6.ndf',
                SIZE = $(SIZE),
                MAXSIZE = $(MAXSIZE),
                FILEGROWTH = $(FILEGROWTH)),
                ( NAME = $(NAME)7,
                FILENAME = '$(DATAPATH)7\mnt\CDWRpt7.ndf',
                SIZE = $(SIZE),
                MAXSIZE = $(MAXSIZE),
                FILEGROWTH = $(FILEGROWTH)),
                ( NAME = $(NAME)8,
                FILENAME = '$(DATAPATH)8\mnt\CDWRpt8.ndf',
                SIZE = $(SIZE),
                MAXSIZE = $(MAXSIZE),
                FILEGROWTH = $(FILEGROWTH))
            LOG ON
               (NAME = $(NAME)Log,
                FILENAME = '$(LOGFILEPATH)\mnt\CDWRpt.ldf',
                SIZE = $(LOGSIZE),
                MAXSIZE = $(LOGMAXSIZE),
                FILEGROWTH = $(LOGFILEGROWTH));
            GO
          GetQuery: |
            USE [master]
            GO
            SELECT * FROM sys.master_files
            WHERE type_desc = 'ROWS'
            AND name = '$(NAME)'
            GO
          TestQuery: |
            SELECT
            CASE
                WHEN EXISTS (
                    SELECT name 
                    FROM sys.databases 
                    WHERE name = '$(NAME)'
                ) THEN NULL
                ELSE 'DB $(NAME) not found; running DB creation'
            END AS Result;
        loop: "{{ caboodle_report_databases }}"
        loop_control:
          loop_var: db

    - name: Configure Caboodle Stage SQL Databases
      when: caboodle_stage_databases is defined
      block:
        - name: Create Cogito SQL Database Files with T-SQL
          ansible.windows.win_dsc:
            resource_name: SqlScriptQuery
            Id: "ConfigureDatabaseFiles"
            InstanceName: "{{ dsc_instancename }}"
            Variable: "NAME={{ db.name }}, SIZE={{ db.db_size }}, MAXSIZE={{ db.db_max_size }}, FILEGROWTH={{ db.db_growth }}, DATAPATH={{db.data_path}},LOGSIZE={{ db.log_size }}, LOGMAXSIZE={{ db.log_max_size }}, LOGFILEGROWTH={{ db.log_growth }}, LOGFILEPATH={{db.log_path}}"
            Encrypt: Optional
            SetQuery: |
              USE [master]
              GO
              CREATE DATABASE $(NAME)
              ON
              PRIMARY
                  (NAME = $(NAME)1,
                  FILENAME = '$(DATAPATH)1\mnt\CDWStg1.mdf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH)),
                  ( NAME = $(NAME)2,
                  FILENAME = '$(DATAPATH)2\mnt\CDWStg2.ndf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH)),
                  (NAME = $(NAME)3,
                  FILENAME = '$(DATAPATH)3\mnt\CDWStg3.mdf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH)),
                  ( NAME = $(NAME)4,
                  FILENAME = '$(DATAPATH)2\mnt\CDWStg4.ndf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH))
              LOG ON
                 (NAME = $(NAME)Log,
                  FILENAME = '$(LOGFILEPATH)\mnt\CDWStg.ldf',
                  SIZE = $(LOGSIZE),
                  MAXSIZE = $(LOGMAXSIZE),
                  FILEGROWTH = $(LOGFILEGROWTH));
              GO
            GetQuery: |
              USE [master]
              GO
              SELECT * FROM sys.master_files
              WHERE type_desc = 'ROWS'
              AND name = '$(NAME)'
              GO
            TestQuery: |
              SELECT
              CASE
                  WHEN EXISTS (
                      SELECT name
                      FROM sys.databases
                      WHERE name = '$(NAME)'
                  ) THEN NULL
                  ELSE 'DB $(NAME) not found; running DB creation'
              END AS Result;
          loop: "{{ caboodle_stage_databases }}"
          loop_control:
            loop_var: db

    - name: Configure SlicerDicer SQL Databases
      when: caboodle_stage_databases is defined
      block:
        - name: Create SlicerDicer SQL Database Files with T-SQL
          ansible.windows.win_dsc:
            resource_name: SqlScriptQuery
            Id: "ConfigureDatabaseFiles"
            InstanceName: "{{ dsc_instancename }}"
            Variable: "NAME={{ db.name }}, SIZE={{ db.db_size }}, MAXSIZE={{ db.db_max_size }}, FILEGROWTH={{ db.db_growth }}, DATAPATH={{db.data_path}},LOGSIZE={{ db.log_size }}, LOGMAXSIZE={{ db.log_max_size }}, LOGFILEGROWTH={{ db.log_growth }}, LOGFILEPATH={{db.log_path}}"
            Encrypt: Optional
            SetQuery: |
              USE [master]
              GO
              CREATE DATABASE $(NAME)
              ON
              PRIMARY
                  (NAME = $(NAME)1,
                  FILENAME = '$(DATAPATH)\mnt\SlicerDicer.mdf',
                  SIZE = $(SIZE),
                  MAXSIZE = $(MAXSIZE),
                  FILEGROWTH = $(FILEGROWTH))
              LOG ON
                 (NAME = $(NAME)_Log,
                  FILENAME = '$(LOGFILEPATH)\mnt\SlicerDicer.ldf',
                  SIZE = $(LOGSIZE),
                  MAXSIZE = $(LOGMAXSIZE),
                  FILEGROWTH = $(LOGFILEGROWTH));
              GO
            GetQuery: |
              USE [master]
              GO
              SELECT * FROM sys.master_files
              WHERE type_desc = 'ROWS'
              AND name = '$(NAME)'
              GO
            TestQuery: |
              SELECT
              CASE
                  WHEN EXISTS (
                      SELECT name
                      FROM sys.databases
                      WHERE name = '$(NAME)'
                  ) THEN NULL
                  ELSE 'DB $(NAME) not found; running DB creation'
              END AS Result;
          loop: "{{ slicerdicer_stage_databases }}"
          loop_control:
            loop_var: db

    - name: Configure Epic best practices for SQL Databases
      when: clarity_report_databases is defined
      block:
      - name: Configure SQL Database Files with T-SQL
        ansible.windows.win_dsc:
          resource_name: SqlScriptQuery
          Id: "TuneDatabaseFiles"
          InstanceName: "{{ dsc_instancename }}"
          Variable: "NAME={{ db.name }}, RECOVERYMODE={{ db.recovery_model }}"
          Encrypt: Optional
          SetQuery: |
            USE [master]
            GO
            ALTER DATABASE [$(NAME)] MODIFY FILEGROUP [primary] AUTOGROW_ALL_FILES
            ALTER DATABASE [$(NAME)] SET MIXED_PAGE_ALLOCATION OFF;
            ALTER DATABASE [$(NAME)] SET ACCELERATED_DATABASE_RECOVERY = ON
            (PERSISTENT_VERSION_STORE_FILEGROUP = [PRIMARY]);
            ALTER DATABASE $(NAME) SET QUERY_STORE = ON;
            ALTER DATABASE $(NAME) SET QUERY_STORE (MAX_STORAGE_SIZE_MB = 4096, QUERY_CAPTURE_MODE = AUTO);
            ALTER DATABASE [$(NAME)] SET COMPATIBILITY_LEVEL = 160;
            ALTER DATABASE [$(NAME)] SET ANSI_NULL_DEFAULT OFF;
            ALTER DATABASE [$(NAME)] SET ANSI_NULLS OFF;
            ALTER DATABASE [$(NAME)] SET ANSI_PADDING OFF;
            ALTER DATABASE [$(NAME)] SET ANSI_WARNINGS OFF;
            ALTER DATABASE [$(NAME)] SET ARITHABORT OFF;
            ALTER DATABASE [$(NAME)] SET AUTO_CLOSE OFF;
            ALTER DATABASE [$(NAME)] SET AUTO_SHRINK OFF;
            ALTER DATABASE [$(NAME)] SET AUTO_CREATE_STATISTICS ON(INCREMENTAL = OFF);
            ALTER DATABASE [$(NAME)] SET AUTO_UPDATE_STATISTICS ON;
            ALTER DATABASE [$(NAME)] SET CURSOR_CLOSE_ON_COMMIT OFF;
            ALTER DATABASE [$(NAME)] SET CURSOR_DEFAULT  GLOBAL;
            ALTER DATABASE [$(NAME)] SET CONCAT_NULL_YIELDS_NULL OFF;
            ALTER DATABASE [$(NAME)] SET NUMERIC_ROUNDABORT OFF;
            ALTER DATABASE [$(NAME)] SET QUOTED_IDENTIFIER OFF;
            ALTER DATABASE [$(NAME)] SET RECURSIVE_TRIGGERS OFF;
            ALTER DATABASE [$(NAME)] SET  DISABLE_BROKER;
            ALTER DATABASE [$(NAME)] SET AUTO_UPDATE_STATISTICS_ASYNC OFF;
            ALTER DATABASE [$(NAME)] SET DATE_CORRELATION_OPTIMIZATION OFF;
            ALTER DATABASE [$(NAME)] SET PARAMETERIZATION SIMPLE;
            ALTER DATABASE [$(NAME)] SET READ_COMMITTED_SNAPSHOT OFF;
            ALTER DATABASE [$(NAME)] SET READ_WRITE;
            ALTER DATABASE [$(NAME)] SET RECOVERY $(RECOVERYMODE);
            ALTER DATABASE [$(NAME)] SET MULTI_USER;
            ALTER DATABASE [$(NAME)] SET PAGE_VERIFY CHECKSUM;
            ALTER DATABASE [$(NAME)] SET TARGET_RECOVERY_TIME = 60 SECONDS;
            ALTER DATABASE [$(NAME)] SET DELAYED_DURABILITY = DISABLED;
          GetQuery: |
            USE [master]
            GO
            SELECT * FROM sys.master_files
            WHERE type_desc = 'ROWS'
            AND name = '$(NAME)'
            GO
          TestQuery: |
            SELECT
            CASE
                WHEN EXISTS (
                    SELECT name
                    FROM sys.databases
                    WHERE name = '$(NAME)'
                ) THEN 'DB $(NAME) found; running DB Tuning'
                ELSE NULL
            END AS Result;
        loop: "{{ clarity_report_databases }}"
        loop_control:
          loop_var: db


# needs - caboodle changes:
# If you are creating your staging database, set Auto Update Statistics to True and Auto Update Statistics Asynchronously to False. 
# If you are creating your reporting database, set both Auto Update Statistics and Auto Update Statistics Asynchronously to True.